<script>
    // --- CONFIGURAÇÃO DAS FONTES DE DADOS ---
    // Usaremos dois proxies para garantir que se um falhar, o outro assume
    const PROXY_MAIN = 'https://corsproxy.io/?';
    const PROXY_BACKUP = 'https://api.allorigins.win/raw?url=';

    const DATA_SOURCES = [
        {
            id: 'BANT4',
            label: 'Leads BANT 4',
            urls: [
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=248606401&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=143072328&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=1603044254&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=1506135346&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=1984064688&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=1894726181&single=true&output=csv'
            ]
        },
        {
            id: 'CONVERTED',
            label: 'Convertidos',
            urls: [
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vSEa5Vvuqbc46W7BQwjo5rnCn52_uX5wv5StJO_THLYf4Ia0b-OJr4xeOC-rmYI9Xmuks3B_t9yqHAL/pub?gid=0&single=true&output=csv'
            ]
        },
        {
            id: 'GERAL',
            label: 'Leads Gerais',
            urls: [
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=772320362&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=401963441&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=2109863438&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=757093779&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=1335882778&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=287072955&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vSq7tm8TN8KWT9sFip9UkeghlkZUOf3J-PKP035h1_EKNvOh-SXCcOakUTXKS5NI2xJ-hzRzQFruaRg/pub?gid=1787906905&single=true&output=csv'
            ]
        },
        {
            id: 'LIVES',
            label: 'Registro de Lives',
            urls: [
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1195020305&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1611425534&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1245533373&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1359391938&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=432642692&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1279965215&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1956828302&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1774314097&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=439503056&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=498164371&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=859560778&single=true&output=csv'
            ]
        }
    ];

    let masterDB = [];

    // --- CARREGAMENTO SEQUENCIAL (PARA EVITAR BLOQUEIO) ---
    async function loadAllData() {
        const loadingText = document.getElementById('loading-text');
        const progressBar = document.getElementById('progress-bar');
        
        let allUrls = [];
        DATA_SOURCES.forEach(cat => {
            cat.urls.forEach(url => allUrls.push({ url, type: cat.id }));
        });

        const totalSheets = allUrls.length;
        let loadedCount = 0;
        let errors = 0;

        // Limpa base antiga
        masterDB = [];

        // Loop Sequencial: Um por um
        for (const item of allUrls) {
            try {
                let rows = [];
                // Tenta Proxy Principal
                try {
                    rows = await fetchSheet(item.url, PROXY_MAIN);
                } catch (e1) {
                    console.warn('Proxy principal falhou, tentando backup...', item.url);
                    // Se falhar, tenta Proxy Backup
                    rows = await fetchSheet(item.url, PROXY_BACKUP);
                }

                if (rows && rows.length > 0) {
                    const normalized = rows.map(r => normalizeData(r, item.type));
                    masterDB = masterDB.concat(normalized);
                }

            } catch (e) {
                console.error(`Falha fatal em ${item.url}`, e);
                errors++;
            }

            loadedCount++;
            const pct = Math.round((loadedCount / totalSheets) * 100);
            progressBar.style.width = pct + '%';
            loadingText.innerText = `Processando planilha ${loadedCount}/${totalSheets}...`;
            
            // Pausa de 200ms para o Google não bloquear
            await new Promise(r => setTimeout(r, 200));
        }

        // Filtra sujeira
        masterDB = masterDB.filter(i => i.name && i.name.length > 1 && i.name !== 'Sem Nome');
        
        console.log(`Finalizado: ${masterDB.length} registros. Erros: ${errors}`);
        
        if (masterDB.length === 0) {
            alert('Atenção: Nenhum dado foi carregado. Verifique se as planilhas ainda estão "Publicadas na Web" como CSV.');
        }

        applyFilters();
        
        // Finaliza loading
        setTimeout(() => {
            document.getElementById('loading-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
        }, 500);
    }

    async function fetchSheet(url, proxyBase) {
        // Adiciona timestamp para evitar cache
        const safeUrl = proxyBase + encodeURIComponent(url + `&t=${Date.now()}`);
        const res = await fetch(safeUrl);
        if (!res.ok) throw new Error('Erro HTTP ' + res.status);
        
        const text = await res.text();
        
        // Validação se é HTML (erro) ou CSV (sucesso)
        if(text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html') || text.includes('Google Drive - Access Denied')) {
            throw new Error('Retornou HTML em vez de CSV');
        }
        
        return parseCSV(text);
    }

    // --- PARSER E NORMALIZAÇÃO ---
    function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
        if (lines.length < 2) return [];

        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g,''));
        
        return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const obj = {};
            headers.forEach((h, i) => {
                let val = values[i] || '';
                val = val.replace(/^"|"$/g, '').trim(); 
                obj[h] = val;
            });
            return obj;
        });
    }

    function normalizeData(row, type) {
        // Helper para achar a chave correta
        const k = (keys) => Object.keys(row).find(key => keys.some(kw => key.includes(kw)));
        
        let name = row[k(['nome', 'cliente', 'loja', 'participante', 'razao', 'lead'])] || 'Sem Nome';
        let email = row[k(['email', 'mail', 'contato', 'e-mail'])] || '-';
        let status = row[k(['status', 'fase', 'etapa', 'situacao', 'situation'])] || 'Ativo';
        
        if (type === 'LIVES' && (status === 'Ativo' || status === '')) {
            status = 'Presente';
        }

        return {
            source: type,
            name: name,
            email: email,
            status: status.toUpperCase(), 
            year: row[k(['ano', 'year', 'data'])] || '-', 
            info: row[k(['franqueado', 'proprietário', 'tema', 'origem', 'criado'])] || '-', 
            rawDate: row[k(['data', 'criado', 'emissão', 'date'])] || ''
        };
    }

    // --- LÓGICA DE UI E FILTROS ---
    document.getElementById('inputSearch').addEventListener('keyup', applyFilters);
    document.getElementById('selectSource').addEventListener('change', applyFilters);
    document.getElementById('selectYear').addEventListener('change', applyFilters);

    function applyFilters() {
        const search = document.getElementById('inputSearch').value.toLowerCase();
        const source = document.getElementById('selectSource').value;
        const year = document.getElementById('selectYear').value;
        
        const filtered = masterDB.filter(i => {
            if (search && !i.name.toLowerCase().includes(search) && !i.email.toLowerCase().includes(search)) return false;
            if (source && i.source !== source) return false;
            if (year && !i.year.includes(year) && !i.rawDate.includes(year)) return false;
            return true;
        });

        updateUI(filtered);
    }

    function updateUI(data) {
        document.getElementById('ov-total').innerText = data.length.toLocaleString();
        document.getElementById('ov-bant').innerText = data.filter(i => i.source === 'BANT4').length.toLocaleString();
        document.getElementById('ov-conv').innerText = data.filter(i => i.source === 'CONVERTED').length.toLocaleString();
        document.getElementById('ov-lives').innerText = data.filter(i => i.source === 'LIVES').length.toLocaleString();

        renderCharts(data);

        renderTable('table-geral', data.filter(i => i.source === 'GERAL'), ['name', 'email', 'status', 'info'], 'count-geral');
        renderTable('table-bant4', data.filter(i => i.source === 'BANT4'), ['name', 'email', 'status', 'info'], 'count-bant4', 'bdg-bant');
        renderTable('table-converted', data.filter(i => i.source === 'CONVERTED'), ['name', 'email', 'status', 'year'], 'count-converted', 'bdg-cvc');
        renderTable('table-lives', data.filter(i => i.source === 'LIVES'), ['name', 'email', 'info', 'status'], 'count-lives', 'bdg-live');
    }

    function renderTable(tableId, data, fields, countId, badgeClass = 'bdg-default') {
        document.getElementById(countId).innerText = data.length;
        const limitData = data.slice(0, 100); 
        
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = limitData.map(row => `
            <tr>
                <td><b>${row[fields[0]]}</b></td>
                <td>${row[fields[1]]}</td>
                <td>
                    ${fields[2] === 'status' 
                        ? `<span class="status-badge ${badgeClass}">${row.status}</span>` 
                        : row[fields[2]]}
                </td>
                <td>
                    ${fields[3] === 'status' 
                        ? `<span class="status-badge ${badgeClass}">${row.status}</span>` 
                        : row[fields[3]]}
                </td>
            </tr>
        `).join('') || '<tr><td colspan="4" style="text-align:center; padding:20px;">Nenhum dado encontrado</td></tr>';
    }

    function renderCharts(data) {
        const sources = { 'GERAL': 0, 'BANT4': 0, 'CONVERTED': 0, 'LIVES': 0 };
        data.forEach(i => sources[i.source] = (sources[i.source]||0) + 1);
        
        const colors = { 'GERAL': '#FF5722', 'BANT4': '#ffe600', 'CONVERTED': '#FFD700', 'LIVES': '#00E5FF' };
        
        let htmlOrigin = '';
        Object.keys(sources).forEach(k => {
            const val = sources[k];
            const max = Math.max(...Object.values(sources)) || 1;
            const pct = (val / max) * 100;
            if(val > 0) {
                htmlOrigin += `
                <div class="chart-row">
                    <div class="chart-label">${k}</div>
                    <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%; background:${colors[k] || '#666'}"></div></div>
                    <div class="chart-value">${val}</div>
                </div>`;
            }
        });
        document.getElementById('chart-origin').innerHTML = htmlOrigin;

        const statuses = {};
        data.forEach(i => statuses[i.status] = (statuses[i.status]||0) + 1);
        const sortedStatus = Object.entries(statuses).sort((a,b) => b[1] - a[1]).slice(0, 5);
        
        let htmlStatus = '';
        const maxStatus = sortedStatus.length > 0 ? sortedStatus[0][1] : 1;
        
        sortedStatus.forEach(([k, v]) => {
            const pct = (v / maxStatus) * 100;
            htmlStatus += `
                <div class="chart-row">
                    <div class="chart-label" style="font-size:0.7rem">${k.substring(0,15)}</div>
                    <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%; background:#fff"></div></div>
                    <div class="chart-value">${v}</div>
                </div>`;
        });
        document.getElementById('chart-status').innerHTML = htmlStatus;
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.view-section').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        btn.classList.add('active');
    }

    window.onload = loadAllData;
</script>
