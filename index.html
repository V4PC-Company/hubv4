<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVC | Hub de Dados Integrado</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0a0502;
            --sidebar-bg: #140a05;
            --card-bg: rgba(35, 15, 10, 0.95);
            --primary-orange: #FF5722;
            --secondary-crimson: #C70039;
            --accent-purple: #900C3F;
            --yellow: #FFD700;
            --bant-color: #ffe600; 
            --border: rgba(255, 87, 34, 0.25);
            --text-main: #e0e0e0;
            --text-muted: #aca09c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at 10% 10%, #3a1005 0%, #0a0502 100%); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--primary-orange); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; }
        .brand { padding: 0 20px 30px; display: flex; align-items: center; gap: 10px; font-family: 'Orbitron', sans-serif; color: var(--primary-orange); font-size: 1rem; letter-spacing: 1px; }
        .menu-item { padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-muted); font-size: 0.85rem; transition: 0.3s; border-left: 3px solid transparent; }
        .menu-item.active { color: white; border-left: 3px solid var(--primary-orange); background: linear-gradient(90deg, rgba(255, 87, 34, 0.2) 0%, transparent 100%); }
        .main-content { flex: 1; overflow-y: auto; padding: 30px; }
        .filters-container { background: var(--card-bg); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 130px; }
        .filter-group label { font-size: 0.7rem; color: var(--primary-orange); font-weight: bold; }
        .filter-input { background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 4px; outline: none; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 25px; overflow: hidden; }
        .card-header { background: rgba(40, 15, 10, 0.95); padding: 15px 20px; border-bottom: 1px solid var(--border); color: #fff; font-size: 0.9rem; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 14px 20px; background: rgba(60, 20, 5, 0.6); color: var(--primary-orange); }
        td { padding: 14px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ccc; }
        .summary-bar { display: flex; gap: 20px; margin-bottom: 25px; }
        .summary-card { background: #000; border: 1px solid var(--border); border-radius: 8px; padding: 15px 25px; flex: 1; text-align: center; }
        .summary-value { color: #fff; font-size: 1.8rem; font-family: 'Orbitron'; }
        .tag-source { font-size: 0.65rem; padding: 4px 10px; border-radius: 4px; font-weight: 700; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; }
        .bdg-bant { background: #689F38; color: #fff; }
        .bdg-cvc { background: #FFC107; color: #000; }
        .dynamic-filter { display: none; }
        .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .chart-row { display: flex; align-items: center; margin-bottom: 10px; }
        .chart-bar-bg { flex: 1; background: #222; height: 10px; border-radius: 5px; margin: 0 10px; }
        .chart-bar-fill { height: 100%; border-radius: 5px; transition: 1s; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="font-family:'Orbitron'; color:var(--primary-orange);">CONECTANDO BASES...</div>
    <div id="loading-text" style="color:#666; font-size:0.8rem; margin-top:10px;">Aguardando Google Sheets...</div>
</div>

<aside class="sidebar">
    <div class="brand"><i class="fas fa-chart-line"></i> V4 | SCALINK</div>
    <div class="menu-item active" onclick="switchTab('page-overview', this)"><i class="fas fa-home"></i> VISÃO GERAL</div>
    <div class="menu-item" onclick="switchTab('page1', this)"><i class="fas fa-layer-group"></i> LEADS GERAIS</div>
    <div class="menu-item" onclick="switchTab('page-bant4', this)"><i class="fas fa-bullseye"></i> LEADS BANT 4</div>
    <div class="menu-item" onclick="switchTab('page-converted', this)"><i class="fas fa-check-circle" style="color:var(--yellow)"></i> CONVERTIDOS</div>
    <div class="menu-item" onclick="switchTab('page-master', this)"><i class="fas fa-database"></i> BASE GERAL</div>
</aside>

<main class="main-content">
    <div class="filters-container">
        <div class="filter-group">
            <label>BUSCAR</label>
            <input type="text" id="inputSearch" class="filter-input" placeholder="Nome ou Email...">
        </div>
        <div class="filter-group dynamic-filter" id="group-year">
            <label>ANO</label>
            <select id="selectYear" class="filter-input"><option value="">Todos</option><option value="2024">2024</option><option value="2025">2025</option></select>
        </div>
        <div class="filter-group">
            <label>ORIGEM</label>
            <select id="selectSource" class="filter-input">
                <option value="">Todas</option>
                <option value="BANT4">BANT 4</option>
                <option value="CONVERTED">Convertidos</option>
            </select>
        </div>
    </div>

    <section id="page-overview" class="view-section active">
        <div class="summary-bar">
            <div class="summary-card"><div style="color:var(--primary-orange)">TOTAL</div><div class="summary-value" id="ov-total">0</div></div>
            <div class="summary-card"><div style="color:var(--bant-color)">BANT</div><div class="summary-value" id="ov-bant">0</div></div>
            <div class="summary-card"><div style="color:var(--yellow)">CONVERTIDOS</div><div class="summary-value" id="ov-conv">0</div></div>
        </div>
        <div class="overview-grid">
            <div class="card"><div class="card-header">Distribuição por Origem</div><div id="chart-origin" style="padding:20px"></div></div>
            <div class="card"><div class="card-header">Top Status</div><div id="chart-funnel" style="padding:20px"></div></div>
        </div>
    </section>

    <section id="page-converted" class="view-section" style="display:none">
        <div class="card" style="border-color: var(--yellow);">
            <div class="card-header">Leads Convertidos (Base Oficial)</div>
            <table>
                <thead>
                    <tr><th>Nome/Loja</th><th>Ano</th><th>Tri</th><th>Status</th><th>Franqueado</th><th>Email</th></tr>
                </thead>
                <tbody id="table-body-converted"></tbody>
            </table>
        </div>
    </section>

    <section id="page1" class="view-section" style="display:none"><div class="card"><div class="card-header">Leads Gerais</div><table><tbody id="table-body-p1"></tbody></table></div></section>
    <section id="page-bant4" class="view-section" style="display:none"><div class="card"><div class="card-header">BANT 4</div><table><tbody id="table-body-bant4"></tbody></table></div></section>
    <section id="page-master" class="view-section" style="display:none"><div class="card"><div class="card-header">Base Geral</div><table><tbody id="table-body-master"></tbody></table></div></section>
</main>

<script>
    const PROXY_URL = 'https://corsproxy.io/?';
    const SHEET_URLS = {
        JUL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=772320362&single=true&output=csv',
        BANT4: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=467308060&single=true&output=csv',
        // NOVO LINK INTEGRADO ABAIXO
        CONVERTED: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSEa5Vvuqbc46W7BQwjo5rnCn52_uX5wv5StJO_THLYf4Ia0b-OJr4xeOC-rmYI9Xmuks3B_t9yqHAL/pub?gid=0&single=true&output=csv'
    };

    let masterDB = [];

    async function loadData() {
        const keys = Object.keys(SHEET_URLS);
        const promises = keys.map(async (key) => {
            try {
                const url = PROXY_URL + encodeURIComponent(SHEET_URLS[key] + `&cache=${Date.now()}`);
                const res = await fetch(url);
                const text = await res.text();
                const rows = parseCSV(text);
                return rows.map(r => normalizeData(r, key));
            } catch (e) { return []; }
        });
        const results = await Promise.all(promises);
        masterDB = results.flat().filter(i => i.name && i.name !== 'Sem Nome');
        applyFilters();
        document.getElementById('loading-overlay').style.display = 'none';
    }

    function parseCSV(text) {
        const lines = text.split('\n').filter(l => l.trim() !== '');
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g,''));
        return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const obj = {};
            headers.forEach((h, i) => obj[h] = (values[i] || '').replace(/"/g,'').trim());
            return obj;
        });
    }

    function normalizeData(row, source) {
        const k = (keys) => Object.keys(row).find(key => keys.some(kw => key.includes(kw)));
        
        return {
            source: source.includes('BANT') ? 'BANT4' : source,
            name: row[k(['nome', 'loja', 'cliente'])] || 'Sem Nome',
            email: row[k(['email', 'mail'])] || '-',
            status: row[k(['status', 'situação', 'fase'])] || 'Ativo',
            year: row[k(['ano', 'year'])] || '-',
            quarter: row[k(['tri', 'período'])] || '-',
            franqueado: row[k(['franqueado', 'proprietário'])] || '-',
            createdAt: row[k(['data', 'criado'])] || ''
        };
    }

    function applyFilters() {
        const search = document.getElementById('inputSearch').value.toLowerCase();
        const source = document.getElementById('selectSource').value;
        
        const filtered = masterDB.filter(i => {
            if (search && !i.name.toLowerCase().includes(search) && !i.email.toLowerCase().includes(search)) return false;
            if (source && i.source !== source) return false;
            return true;
        });

        renderOverview(filtered);
        renderTables(filtered);
    }

    function renderOverview(data) {
        document.getElementById('ov-total').innerText = data.length;
        document.getElementById('ov-bant').innerText = data.filter(i => i.source === 'BANT4').length;
        document.getElementById('ov-conv').innerText = data.filter(i => i.source === 'CONVERTED').length;

        // Gráfico de Origem
        const counts = {}; data.forEach(i => counts[i.source] = (counts[i.source]||0)+1);
        document.getElementById('chart-origin').innerHTML = Object.entries(counts).map(([k,v]) => {
            const pct = (v/data.length)*100;
            const color = k === 'CONVERTED' ? 'var(--yellow)' : 'var(--primary-orange)';
            return `<div class="chart-row">
                <div style="width:100px; font-size:0.7rem">${k}</div>
                <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%; background:${color}"></div></div>
                <div style="width:30px">${v}</div>
            </div>`;
        }).join('');
    }

    function renderTables(data) {
        const conv = data.filter(i => i.source === 'CONVERTED');
        const tbody = document.getElementById('table-body-converted');
        tbody.innerHTML = conv.map(i => `
            <tr>
                <td><b>${i.name}</b></td>
                <td>${i.year}</td>
                <td>${i.quarter}</td>
                <td><span class="status-badge bdg-cvc">${i.status}</span></td>
                <td>${i.franqueado}</td>
                <td>${i.email}</td>
            </tr>
        `).join('') || '<tr><td colspan="6">Nenhum dado</td></tr>';
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.view-section').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('group-year').style.display = (id === 'page-converted') ? 'flex' : 'none';
    }

    window.onload = loadData;
</script>
</body>
</html>
