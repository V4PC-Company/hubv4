<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVC | Hub de Dados Integrado 2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0a0502;
            --sidebar-bg: #140a05;
            --card-bg: rgba(35, 15, 10, 0.95);
            --primary-orange: #FF5722;
            --yellow: #FFD700;
            --bant-color: #ffe600; 
            --lives-color: #00E5FF; /* Cor nova para Lives */
            --border: rgba(255, 87, 34, 0.25);
            --text-main: #e0e0e0;
            --text-muted: #aca09c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at 10% 10%, #3a1005 0%, #0a0502 100%); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }
        
        /* Loading */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--primary-orange); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-bar-container { width: 300px; height: 4px; background: #333; border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .loading-bar-fill { height: 100%; background: var(--primary-orange); width: 0%; transition: width 0.3s; }

        /* Sidebar */
        .sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; }
        .brand { padding: 0 20px 30px; display: flex; align-items: center; gap: 10px; font-family: 'Orbitron', sans-serif; color: var(--primary-orange); font-size: 1rem; letter-spacing: 1px; }
        .menu-item { padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-muted); font-size: 0.85rem; transition: 0.3s; border-left: 3px solid transparent; }
        .menu-item:hover { background: rgba(255, 87, 34, 0.05); color: #fff; }
        .menu-item.active { color: white; border-left: 3px solid var(--primary-orange); background: linear-gradient(90deg, rgba(255, 87, 34, 0.2) 0%, transparent 100%); }
        
        /* Main */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; }
        
        /* Filters */
        .filters-container { background: var(--card-bg); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 130px; }
        .filter-group label { font-size: 0.7rem; color: var(--primary-orange); font-weight: bold; }
        .filter-input { background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 4px; outline: none; }
        
        /* Cards & Tables */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 25px; overflow: hidden; }
        .card-header { background: rgba(40, 15, 10, 0.95); padding: 15px 20px; border-bottom: 1px solid var(--border); color: #fff; font-size: 0.9rem; text-transform: uppercase; display: flex; justify-content: space-between; }
        .count-badge { background: #333; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 14px 20px; background: rgba(60, 20, 5, 0.6); color: var(--primary-orange); position: sticky; top: 0; }
        td { padding: 14px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ccc; }
        tr:hover td { background: rgba(255, 87, 34, 0.05); }

        /* Overview Widgets */
        .summary-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .summary-card { background: #000; border: 1px solid var(--border); border-radius: 8px; padding: 20px; text-align: center; position: relative; overflow: hidden; }
        .summary-card::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary-orange); }
        .card-bant::after { background: var(--bant-color); }
        .card-conv::after { background: var(--yellow); }
        .card-lives::after { background: var(--lives-color); }
        
        .summary-value { color: #fff; font-size: 2rem; font-family: 'Orbitron'; margin-top: 10px; }
        .summary-label { font-size: 0.75rem; color: #888; letter-spacing: 1px; }

        /* Badges */
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; }
        .bdg-bant { background: rgba(104, 159, 56, 0.2); color: #8bc34a; border: 1px solid #8bc34a; }
        .bdg-cvc { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107; }
        .bdg-live { background: rgba(0, 229, 255, 0.2); color: #00e5ff; border: 1px solid #00e5ff; }
        .bdg-default { background: #333; color: #aaa; }

        /* Charts */
        .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 0.8rem; }
        .chart-label { width: 120px; color: #aaa; }
        .chart-bar-bg { flex: 1; background: #222; height: 8px; border-radius: 4px; margin: 0 15px; overflow: hidden; }
        .chart-bar-fill { height: 100%; border-radius: 4px; width: 0; transition: width 1s ease-out; }
        .chart-value { width: 40px; text-align: right; font-family: 'Orbitron'; color: #fff; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0502; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-orange); }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="font-family:'Orbitron'; color:var(--primary-orange); letter-spacing: 2px;">CONECTANDO BASES</div>
    <div id="loading-text" style="color:#666; font-size:0.8rem; margin-top:10px;">Inicializando proxy...</div>
    <div class="loading-bar-container">
        <div class="loading-bar-fill" id="progress-bar"></div>
    </div>
</div>

<aside class="sidebar">
    <div class="brand"><i class="fas fa-network-wired"></i> CVC | HUB 2.0</div>
    
    <div class="menu-item active" onclick="switchTab('page-overview', this)">
        <i class="fas fa-home"></i> VISÃO GERAL
    </div>
    
    <div style="margin: 15px 20px; font-size: 0.65rem; color: #555; font-weight: bold;">FONTES DE DADOS</div>

    <div class="menu-item" onclick="switchTab('page-geral', this)">
        <i class="fas fa-layer-group"></i> LEADS GERAIS
    </div>
    <div class="menu-item" onclick="switchTab('page-bant4', this)">
        <i class="fas fa-bullseye" style="color:var(--bant-color)"></i> LEADS BANT 4
    </div>
    <div class="menu-item" onclick="switchTab('page-converted', this)">
        <i class="fas fa-check-circle" style="color:var(--yellow)"></i> CONVERTIDOS
    </div>
    <div class="menu-item" onclick="switchTab('page-lives', this)">
        <i class="fas fa-video" style="color:var(--lives-color)"></i> REGISTRO DE LIVES
    </div>
    
    <div style="margin-top: auto; padding: 20px; font-size: 0.7rem; color: #444;">
        v2.4 - Sync: Auto
    </div>
</aside>

<main class="main-content">
    <div class="filters-container">
        <div class="filter-group" style="flex: 2;">
            <label>BUSCAR (NOME OU EMAIL)</label>
            <input type="text" id="inputSearch" class="filter-input" placeholder="Digite para filtrar em tempo real...">
        </div>
        <div class="filter-group">
            <label>ORIGEM</label>
            <select id="selectSource" class="filter-input">
                <option value="">Todas as Fontes</option>
                <option value="GERAL">Leads Gerais</option>
                <option value="BANT4">BANT 4</option>
                <option value="CONVERTED">Convertidos</option>
                <option value="LIVES">Lives</option>
            </select>
        </div>
        <div class="filter-group">
            <label>ANO (ESTIMADO)</label>
            <select id="selectYear" class="filter-input">
                <option value="">Todos</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
            </select>
        </div>
    </div>

    <section id="page-overview" class="view-section active">
        <div class="summary-bar">
            <div class="summary-card">
                <div class="summary-label">TOTAL INTEGRADO</div>
                <div class="summary-value" id="ov-total">0</div>
            </div>
            <div class="summary-card card-bant">
                <div class="summary-label" style="color:var(--bant-color)">OPORTUNIDADES (BANT)</div>
                <div class="summary-value" id="ov-bant">0</div>
            </div>
            <div class="summary-card card-conv">
                <div class="summary-label" style="color:var(--yellow)">VENDAS (CONV.)</div>
                <div class="summary-value" id="ov-conv">0</div>
            </div>
            <div class="summary-card card-lives">
                <div class="summary-label" style="color:var(--lives-color)">AUDIÊNCIA LIVES</div>
                <div class="summary-value" id="ov-lives">0</div>
            </div>
        </div>

        <div class="overview-grid">
            <div class="card">
                <div class="card-header">Volume por Origem de Dados</div>
                <div id="chart-origin" style="padding:25px"></div>
            </div>
            <div class="card">
                <div class="card-header">Funil de Status (Top 5)</div>
                <div id="chart-status" style="padding:25px"></div>
            </div>
        </div>
    </section>

    <section id="page-geral" class="view-section" style="display:none">
        <div class="card">
            <div class="card-header">Base Geral <span id="count-geral" class="count-badge">0</span></div>
            <div style="overflow-x:auto">
                <table id="table-geral"><thead><tr><th>Nome</th><th>Email</th><th>Status</th><th>Data/Info</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </section>

    <section id="page-bant4" class="view-section" style="display:none">
        <div class="card" style="border-color: var(--bant-color);">
            <div class="card-header">Leads Qualificados (BANT) <span id="count-bant4" class="count-badge">0</span></div>
            <div style="overflow-x:auto">
                <table id="table-bant4"><thead><tr><th>Nome</th><th>Email</th><th>Status</th><th>Franqueado</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </section>

    <section id="page-converted" class="view-section" style="display:none">
        <div class="card" style="border-color: var(--yellow);">
            <div class="card-header">Clientes Convertidos <span id="count-converted" class="count-badge">0</span></div>
            <div style="overflow-x:auto">
                <table id="table-converted"><thead><tr><th>Cliente/Loja</th><th>Email</th><th>Status</th><th>Período</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </section>

    <section id="page-lives" class="view-section" style="display:none">
        <div class="card" style="border-color: var(--lives-color);">
            <div class="card-header">Registro de Lives <span id="count-lives" class="count-badge">0</span></div>
            <div style="overflow-x:auto">
                <table id="table-lives"><thead><tr><th>Participante</th><th>Email/Contato</th><th>Tema/Origem</th><th>Status</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </section>

</main>

<script>
    // --- CONFIGURAÇÃO DAS FONTES DE DADOS ---
    const PROXY_URL = 'https://corsproxy.io/?';

    // Agrupamento dos links fornecidos por Categoria
    const DATA_SOURCES = [
        {
            id: 'BANT4',
            label: 'Leads BANT 4',
            urls: [
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=248606401&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=143072328&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=1603044254&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=1506135346&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=1984064688&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpMZl1dumtMC9i5o3gDJdpzjrcfHwJtJrNe-JJTMZsWdW1Na9hq5f1mACgleTpzDnLks9PkjyaMEmS/pub?gid=1894726181&single=true&output=csv'
            ]
        },
        {
            id: 'CONVERTED',
            label: 'Convertidos',
            urls: [
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vSEa5Vvuqbc46W7BQwjo5rnCn52_uX5wv5StJO_THLYf4Ia0b-OJr4xeOC-rmYI9Xmuks3B_t9yqHAL/pub?gid=0&single=true&output=csv'
            ]
        },
        {
            id: 'GERAL',
            label: 'Leads Gerais',
            urls: [
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=772320362&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=401963441&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=2109863438&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=757093779&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=1335882778&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHhCGnGZE8orimuTnbCECn7NqqIoYvcGUHo_6g1A8nbLx56sZT572JdEHpg_uSMQJEYE2uKV4_WUAd/pub?gid=287072955&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vSq7tm8TN8KWT9sFip9UkeghlkZUOf3J-PKP035h1_EKNvOh-SXCcOakUTXKS5NI2xJ-hzRzQFruaRg/pub?gid=1787906905&single=true&output=csv'
            ]
        },
        {
            id: 'LIVES',
            label: 'Registro de Lives',
            urls: [
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1195020305&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1611425534&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1245533373&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1359391938&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=432642692&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1279965215&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1956828302&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=1774314097&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=439503056&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=498164371&single=true&output=csv',
                'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KWWCjb7eYtXhLEpsgxgRI7wurO2HqO0YLcoSAKxkdLTuVGNiQ86HRMz5AKLaIJbnckxl9P4d6TJP/pub?gid=859560778&single=true&output=csv'
            ]
        }
    ];

    let masterDB = [];

    // --- LÓGICA DE CARREGAMENTO ---
    async function loadAllData() {
        const loadingText = document.getElementById('loading-text');
        const progressBar = document.getElementById('progress-bar');
        
        let allUrls = [];
        DATA_SOURCES.forEach(cat => {
            cat.urls.forEach(url => allUrls.push({ url, type: cat.id }));
        });

        const totalSheets = allUrls.length;
        let loadedCount = 0;
        let errors = 0;

        const promises = allUrls.map(async (item) => {
            try {
                // Adiciona timestamp para evitar cache
                const safeUrl = PROXY_URL + encodeURIComponent(item.url + `&t=${Date.now()}`);
                const res = await fetch(safeUrl);
                
                if (!res.ok) throw new Error('Erro HTTP');
                
                const text = await res.text();
                
                // Validação básica se é CSV (evita links de gráficos/html)
                if(text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                    console.warn('Ignorando arquivo não-CSV:', item.url);
                    return [];
                }

                const rows = parseCSV(text);
                
                loadedCount++;
                const pct = Math.round((loadedCount / totalSheets) * 100);
                progressBar.style.width = pct + '%';
                loadingText.innerText = `Carregando bases... ${pct}%`;

                return rows.map(r => normalizeData(r, item.type));
            } catch (e) {
                console.error(`Falha ao carregar ${item.type}`, e);
                errors++;
                loadedCount++; // Conta como processado mesmo com erro
                return [];
            }
        });

        const results = await Promise.all(promises);
        masterDB = results.flat().filter(i => i.name && i.name.length > 1 && i.name !== 'Sem Nome');
        
        console.log(`Total carregado: ${masterDB.length} registros. Erros: ${errors}`);
        
        applyFilters();
        
        // Finaliza loading
        setTimeout(() => {
            document.getElementById('loading-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
        }, 500);
    }

    // --- PARSER E NORMALIZAÇÃO ---
    function parseCSV(text) {
        // Remove linhas vazias e quebras estranhas
        const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
        if (lines.length < 2) return [];

        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g,''));
        
        return lines.slice(1).map(line => {
            // Regex complexo para lidar com vírgulas dentro de aspas
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const obj = {};
            headers.forEach((h, i) => {
                let val = values[i] || '';
                val = val.replace(/^"|"$/g, '').trim(); // Remove aspas das pontas
                obj[h] = val;
            });
            return obj;
        });
    }

    function normalizeData(row, type) {
        // Helper para achar a chave correta
        const k = (keys) => Object.keys(row).find(key => keys.some(kw => key.includes(kw)));
        
        // Mapeamento Inteligente
        let name = row[k(['nome', 'cliente', 'loja', 'participante', 'razao', 'lead'])] || 'Sem Nome';
        let email = row[k(['email', 'mail', 'contato', 'e-mail'])] || '-';
        let status = row[k(['status', 'fase', 'etapa', 'situacao', 'situation'])] || 'Ativo';
        
        // Tratamento específico para Lives (se não tiver status claro, usa 'Participante')
        if (type === 'LIVES' && status === 'Ativo') {
            status = 'Presente';
        }

        return {
            source: type,
            name: name,
            email: email,
            status: status.toUpperCase(), // Padroniza status
            year: row[k(['ano', 'year', 'data'])] || '-', // Tenta pegar ano ou data
            info: row[k(['franqueado', 'proprietário', 'tema', 'origem', 'criado'])] || '-', // Campo genérico extra
            rawDate: row[k(['data', 'criado', 'emissão', 'date'])] || ''
        };
    }

    // --- LÓGICA DE UI E FILTROS ---
    
    // Adicionar Event Listeners para filtragem em tempo real
    document.getElementById('inputSearch').addEventListener('keyup', applyFilters);
    document.getElementById('selectSource').addEventListener('change', applyFilters);
    document.getElementById('selectYear').addEventListener('change', applyFilters);

    function applyFilters() {
        const search = document.getElementById('inputSearch').value.toLowerCase();
        const source = document.getElementById('selectSource').value;
        const year = document.getElementById('selectYear').value;
        
        const filtered = masterDB.filter(i => {
            // Filtro Texto
            if (search && !i.name.toLowerCase().includes(search) && !i.email.toLowerCase().includes(search)) return false;
            // Filtro Origem
            if (source && i.source !== source) return false;
            // Filtro Ano (básico, verifica se a string de data contém o ano)
            if (year && !i.year.includes(year) && !i.rawDate.includes(year)) return false;
            return true;
        });

        updateUI(filtered);
    }

    function updateUI(data) {
        // Atualiza KPIs Visão Geral
        document.getElementById('ov-total').innerText = data.length.toLocaleString();
        document.getElementById('ov-bant').innerText = data.filter(i => i.source === 'BANT4').length.toLocaleString();
        document.getElementById('ov-conv').innerText = data.filter(i => i.source === 'CONVERTED').length.toLocaleString();
        document.getElementById('ov-lives').innerText = data.filter(i => i.source === 'LIVES').length.toLocaleString();

        // Atualiza Gráficos (HTML based)
        renderCharts(data);

        // Atualiza Tabelas
        renderTable('table-geral', data.filter(i => i.source === 'GERAL'), ['name', 'email', 'status', 'info'], 'count-geral');
        renderTable('table-bant4', data.filter(i => i.source === 'BANT4'), ['name', 'email', 'status', 'info'], 'count-bant4', 'bdg-bant');
        renderTable('table-converted', data.filter(i => i.source === 'CONVERTED'), ['name', 'email', 'status', 'year'], 'count-converted', 'bdg-cvc');
        renderTable('table-lives', data.filter(i => i.source === 'LIVES'), ['name', 'email', 'info', 'status'], 'count-lives', 'bdg-live');
    }

    function renderTable(tableId, data, fields, countId, badgeClass = 'bdg-default') {
        document.getElementById(countId).innerText = data.length;
        const limitData = data.slice(0, 100); // Renderiza max 100 para performance
        
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = limitData.map(row => `
            <tr>
                <td><b>${row[fields[0]]}</b></td>
                <td>${row[fields[1]]}</td>
                <td>
                    ${fields[2] === 'status' 
                        ? `<span class="status-badge ${badgeClass}">${row.status}</span>` 
                        : row[fields[2]]}
                </td>
                <td>
                    ${fields[3] === 'status' 
                        ? `<span class="status-badge ${badgeClass}">${row.status}</span>` 
                        : row[fields[3]]}
                </td>
            </tr>
        `).join('') || '<tr><td colspan="4" style="text-align:center; padding:20px;">Nenhum dado encontrado</td></tr>';
    }

    function renderCharts(data) {
        // Gráfico 1: Origem
        const sources = { 'GERAL': 0, 'BANT4': 0, 'CONVERTED': 0, 'LIVES': 0 };
        data.forEach(i => sources[i.source] = (sources[i.source]||0) + 1);
        
        const colors = { 'GERAL': '#FF5722', 'BANT4': '#ffe600', 'CONVERTED': '#FFD700', 'LIVES': '#00E5FF' };
        
        let htmlOrigin = '';
        Object.keys(sources).forEach(k => {
            const val = sources[k];
            const max = Math.max(...Object.values(sources)) || 1;
            const pct = (val / max) * 100;
            if(val > 0) {
                htmlOrigin += `
                <div class="chart-row">
                    <div class="chart-label">${k}</div>
                    <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%; background:${colors[k] || '#666'}"></div></div>
                    <div class="chart-value">${val}</div>
                </div>`;
            }
        });
        document.getElementById('chart-origin').innerHTML = htmlOrigin;

        // Gráfico 2: Status Top 5
        const statuses = {};
        data.forEach(i => statuses[i.status] = (statuses[i.status]||0) + 1);
        const sortedStatus = Object.entries(statuses).sort((a,b) => b[1] - a[1]).slice(0, 5);
        
        let htmlStatus = '';
        const maxStatus = sortedStatus.length > 0 ? sortedStatus[0][1] : 1;
        
        sortedStatus.forEach(([k, v]) => {
            const pct = (v / maxStatus) * 100;
            htmlStatus += `
                <div class="chart-row">
                    <div class="chart-label" style="font-size:0.7rem">${k.substring(0,15)}</div>
                    <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%; background:#fff"></div></div>
                    <div class="chart-value">${v}</div>
                </div>`;
        });
        document.getElementById('chart-status').innerHTML = htmlStatus;
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.view-section').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        btn.classList.add('active');
    }

    // Inicializa
    window.onload = loadAllData;

</script>
</body>
</html>
